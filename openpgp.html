<!doctype html>

<html lang="en">
<head>
<meta charset="utf-8">

<title>The HTML5 Herald</title>
<meta name="description" content="The HTML5 Herald">
<meta name="author" content="SitePoint">

<link rel="stylesheet" href="css/styles.css?v=1.0">

<!--[if lt IE 9]>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.js"></script>
<![endif]-->
</head>

<body>
<script src="openpgp/openpgp.js"></script>
<h2>demo</h2>

<div id="pubkey" style="display: none;">
-----BEGIN PGP PUBLIC KEY BLOCK-----
Version: GnuPG v2

mI0EV7LUUAEEANWJNyAUN7Zy/oAbGh08dRYfXlXAyos3kF9movVMfFsHUhpnTstm
qH0pgXib0vKyKmtJjm/UW7m2ODbeYDjwW+MdtEBmaUSqe6EgFMQdhok8waUMcdoq
h8TewZmNSgkIkLD4J8cU+rPrzVUKKOf91HHhutnV/HFYNMLsYTjENJX5ABEBAAG0
L0NocmlzdGlhbiBIYWhuICh0ZXN0a2V5KSA8Y2hhaG5AbGl2aW5nbG9naWMuZGU+
iLkEEwEIACMFAley1FACGwMHCwkIBwMCAQYVCAIJCgsEFgIDAQIeAQIXgAAKCRBd
6Ew2nQpYucz9A/9TKnBME2JwRAXS8VVEMyGvPg0iwYAoy03vNIui0e/DdAqprgSa
e87m00q7GI+kSNz2VOaBkaHRjjzI1b2WJ0BhYNsrXEwLVWmpkksw4EPUuvQk3a1O
F1+0eyHshz2e1xORqmotXrOiWZChIUxFIZyRkOOYNuIbo9NpZeSVa4jQ9biNBFey
1FABBADHpsjoi6kEavc1aWPdUBlObpRp1rlOgUYMrbf6EQxMAwhmVLWRSFuVfSK1
1m3PAddMPG/66bkv6El9o2BaSn44DtQURc8EZ4fJvOo06Hm9/HJM8L/PbU1K4st3
b34WymciUaowPVBSRKGrgJ7/mbDmcAHDFyZ0p85n0OW2k8tZUwARAQABiJ8EGAEI
AAkFAley1FACGwwACgkQXehMNp0KWLnSOQQA0V0gI1Rb05jELDh0POZiPXdYSxf2
7XDXzQXCxuzvx4JnzD6JYsnVmh6voKn8Tu0Pthy6wh03GqhEneGkggX1Rs7vLQMZ
kPL1YG4cdMiAcXt+D+iMcaMJd7x2p4B5ypj+M85ornQgHirYowmGCVb++FTdn8pg
0S1a1g21B+adqgE=
=qRGF
-----END PGP PUBLIC KEY BLOCK-----
</div>
<div id="privkey" style="display: none;">
-----BEGIN PGP PRIVATE KEY BLOCK-----
Version: GnuPG v2

lQH+BFey1FABBADViTcgFDe2cv6AGxodPHUWH15VwMqLN5BfZqL1THxbB1IaZ07L
Zqh9KYF4m9LysiprSY5v1Fu5tjg23mA48FvjHbRAZmlEqnuhIBTEHYaJPMGlDHHa
KofE3sGZjUoJCJCw+CfHFPqz681VCijn/dRx4brZ1fxxWDTC7GE4xDSV+QARAQAB
/gMDAu3g+T7spFgQ41cinzqjvRLVI0ZcLbbBQnMcLSzCqPLk2jgy6wvjLg3/dyck
RMbEyokoOAUyNLmVa1wWUWFnqMSHrMJz/FSoE2evT2OiLytQHf7hFEWWsGqBtq3s
DPnwFbnrkN4SnJNuEtKzxrPsCT3Z1O2u/hC7/z25jIaPdMVLZOixjR86THxOnKCU
Cm80l2U5opHwR1uGYUWusGNRURoY/4pNGvXshznXA1uIMoxcAd4UiW0n3jRBs9lb
ljjCPGdQh49bYVIIni+sBBz9nU5N1+K/wlSzTEc83c/b1FpdTphzgdLaWADk326z
hrNK1P5xzIr/cjBVjPbqj5OQ4PZsIhleC0wiGmfAsR+Q0Cy0ppDDGISrfy0qD32Q
h6Lu2UakB8XxhjEfzgO9ZtHTG5w5lOzPHKg2GG6DjKk61EZ1kouliOENaJCG7tGk
1e1I9H5fsdcVphGl8sKy6wVxZoMk+pAcY7oCD/r1pQ9FtC9DaHJpc3RpYW4gSGFo
biAodGVzdGtleSkgPGNoYWhuQGxpdmluZ2xvZ2ljLmRlPoi5BBMBCAAjBQJXstRQ
AhsDBwsJCAcDAgEGFQgCCQoLBBYCAwECHgECF4AACgkQXehMNp0KWLnM/QP/Uypw
TBNicEQF0vFVRDMhrz4NIsGAKMtN7zSLotHvw3QKqa4EmnvO5tNKuxiPpEjc9lTm
gZGh0Y48yNW9lidAYWDbK1xMC1VpqZJLMOBD1Lr0JN2tThdftHsh7Ic9ntcTkapq
LV6zolmQoSFMRSGckZDjmDbiG6PTaWXklWuI0PWdAf4EV7LUUAEEAMemyOiLqQRq
9zVpY91QGU5ulGnWuU6BRgytt/oRDEwDCGZUtZFIW5V9IrXWbc8B10w8b/rpuS/o
SX2jYFpKfjgO1BRFzwRnh8m86jToeb38ckzwv89tTUriy3dvfhbKZyJRqjA9UFJE
oauAnv+ZsOZwAcMXJnSnzmfQ5baTy1lTABEBAAH+AwMC7eD5PuykWBDj7wobC/pB
+dod0PzUG6A8xRMvFMCrej/FFS3uYX2m1ZFoHr4PoPNZd3kzzUMxxeuO2SKf3VL9
J6dPa1nvnLBllxooR6e4G/8Moy1gsncuYaLSO+VsEs63gD9MKof5XgtzOiujBClf
B1NkZ3HAmSZMQjoE/FghfHszguZadDW3AV+uCvTTtVydSV14GFiT2TrApswk0uYO
DET2oYSQWFFx7DDkFoCDCVzszhZQVJcmn+fE87g03SxFr4ekL8zAmiYDndPU8of0
mhzzbe2opqNrqrbIJ2qlnBp7ErP5Wov8gjq92o3mAI8oKFYfNoagqgUJwLNJOqNd
3pycLX6+YDoRWCeSGZMGcH+YVINy12bDB5R83HgyE9C8kcYe7ITEczAQhk5ZvlJG
I7sunsudd7/vIK7xnQHsn762ABJZATjEVpcR1Oaeew+CPs5m7IQbTOWVVF+mxeIx
eY+MR8RL73yZNI2alJWInwQYAQgACQUCV7LUUAIbDAAKCRBd6Ew2nQpYudI5BADR
XSAjVFvTmMQsOHQ85mI9d1hLF/btcNfNBcLG7O/HgmfMPoliydWaHq+gqfxO7Q+2
HLrCHTcaqESd4aSCBfVGzu8tAxmQ8vVgbhx0yIBxe34P6Ixxowl3vHangHnKmP4z
zmiudCAeKtijCYYJVv74VN2fymDRLVrWDbUH5p2qAQ==
=V3o4
-----END PGP PRIVATE KEY BLOCK-----
</div>
<br/><br/><br/>

<!-- <button class="js-pgp-lock-private-key">Lock Private Key</button> -->
<button class="js-initialize-bob">Initialize Bob</button> <br/><br/>

<div class="js-pgp-generate-key-container">  
  <input class="js-pgp-user-name" placeholder="John Appleseed" value="John Appleseed" type="text" />
  <input class="js-pgp-email" placeholder="E-Mail" value="john@example.org" type="text" />
  <input class="js-pgp-password" placeholder="Password" value="ll123" type="password" />
  <button class="js-pgp-generate-key" type="button">Generate Private Key</button>
</div>

<div class="js-pgp-encrypt-content-container" style="display: none;">
  <textarea class="js-pgp-plaintext-input"></textarea>
  <select class="js-pgp-recipient">
    <option selected>Alice</option>
    <option>Bob</option>
  </select>
  <p class="js-pgp-ciphertext"></p>
  <button class="js-pgp-encrypt-content">Encrypt</button>
  <hr/>
</div>

<div class="js-pgp-decrypt-content-container" style="display: none;">
  <textarea class="js-pgp-ciphertext-input"></textarea>
  <p class="js-pgp-plaintext"></p>
  <button class="js-pgp-decrypt-content">Decrypt</button>
  <hr/>
</div>

<script type="text/javascript">

var Alice, Bob;

var User = function() {
  var self = this;
  this.key = {};
  this.userName = "John Appleseed";
  this.keylength = 2048;
  this.email = "john@example.org";

  this.generateKey = function(callback) {
    var opt = {
      userIds: [{ name: this.userName, email: this.email }],
      numBits: this.keylength
    };

    console.time('Generating Key');
    openpgp.generateKey(opt).then(function(newKey) {
      self.key = newKey;
      callback(newKey);
    });

  };

  this.loadKey = function(privateKey) {
    var passphrase;

    this.key = openpgp.key.readArmored(privateKey);
    passphrase = prompt("Enter your passphrase");
    this.key.keys[0].decrypt(passphrase);
  };

  this.encrypt = function(message, publicKey) {
    publicKey = publicKey || this.key.publicKeyArmored;

    return openpgp.encrypt({
      data: message,
      publicKeys: openpgp.key.readArmored(publicKey).keys[0]
    });
  };

  this.decrypt = function(ciphertext) {
    var msgAsciiArmored = ciphertext;

    return openpgp.decrypt({
      message: openpgp.message.readArmored(msgAsciiArmored),
      privateKey: this.key.key
    });
  };

  this.lockKey = function() {console.log('Not Implemented')};

};

document.querySelector('.js-pgp-generate-key').addEventListener('click', function() {
  Alice = new User();
  Alice.email = document.querySelector('.js-pgp-email').value;
  Alice.userName = document.querySelector('.js-pgp-user-name').value;
  Alice.password = document.querySelector('.js-pgp-password').value;

  Alice.generateKey(function(key) {
    console.timeEnd('Generating Key');
    console.log('Key was successfully generated');
    document.querySelector('.js-pgp-generate-key-container').style.display = 'none';
    document.querySelector('.js-pgp-encrypt-content-container').style.display = 'block';
    document.querySelector('.js-pgp-decrypt-content-container').style.display = 'block';
  });

});

document.querySelector('.js-pgp-encrypt-content').addEventListener('click', function() {
  var plaintext = document.querySelector('.js-pgp-plaintext-input').value;
  var recipient = document.querySelector('.js-pgp-recipient option:selected')

  Alice.encrypt(plaintext).then(function(encrypted) {
    document.querySelector('.js-pgp-ciphertext').innerText = encrypted.data;
  });
});

document.querySelector('.js-pgp-decrypt-content').addEventListener('click', function() {
  var ciphertext = document.querySelector('.js-pgp-ciphertext-input').value;

  Alice.decrypt(ciphertext).then(function(decrypted) {
    document.querySelector('.js-pgp-plaintext').innerText = decrypted.data;
  });
});

// document.querySelector('.js-pgp-decrypt-content-placeholder').addEventListener('click', function() {
//   Alice.lockKey();
// });


var initializeBob = function() {
  var privateKeyArmored = document.querySelector('#privkey').innerHTML;

  Bob = new User();
  Bob.loadKey(privateKeyArmored);


};

document.querySelector('.js-initialize-bob').addEventListener('click', function() {
  initializeBob();
});

</script>
</body>
</html>
